

## Парсер результатов серии игр "Без дураков. Белград."

Парсит результаты игр из xlsm и складывает их в реляционную БД.

Проект также содержит ORM на базе SQLAlchemy для упрощения анализа накопленных данных.

### Как пользоваться парсером.

Все инструкции даны на примере linux. Если для других ОС обнаружатся существенные отличия, пишите о них в [трекер](https://github.com/Korridzy/bez_durakov_parser/issues). Или даже вносите изменения непосредственно в [этот документ](https://github.com/Korridzy/bez_durakov_parser/blob/main/README.md), если умеете.



#### Установка

Откройте терминал bash и выполните следующие команды:
- ```bash
  $ cd /your/comfortable/path
  ```

- ```bash
  $ git clone https://github.com/Korridzy/bez_durakov_parser.git
  ```

- ```bash
  $ cd bez_durakov_parser
  ```

- ```bash
  $ make setup
  ```

На этом этапе будет создана виртуальная среда в каталоге `/your/comfortable/path/bez_durakov_parser/.venv`, и в неё будут установлены все необходимые зависимости.

Далее необходимо прописать в config.toml строку доступа к БД, которую вы собираетесь использовать. По умолчанию это локальная файловая SQLite:

```toml
[database]
url = "sqlite:///./bez_durakov.db"
sqlalchemy_logging = false
```

Также на данный момент поддерживается подключение к MySQL. В конфиге имеется закомментированная строка подключения в качестве примера:

```toml
url = "mysql+pymysql://username:password@srv_address:port/db_name?ssl_ca=/path/to/ca.pem&ssl_cert=/path/to/client-cert.pem&ssl_key=/path/to/client-key.pem"
```

Если вы настраиваете БД с нуля или апгрейдитесь до новой версии схемы, выполните обновление схемы:

```bash
$ make upgrade-db
```

Активируйте виртуальную среду:

```bash
$ source .venv/bin/activate
```



#### Обновление 

Код парсера или ORM можно обновить до последнего лежащего в ветке main при помощи команды:

```bash
$make upgrade-code
```

Если ваш локальный config.toml отличается от лежащего в репозитории, то он будет сохранён, а все остальные файлы обновлены. Если вы изменили ещё какие-то файлы, то автоматического обновления не произойдёт.



#### Использование

Теперь вы можете использовать парсер для добавления игр в БД:

```bash
$ python parse_data.py -h
usage: parse_data.py [-h] [--no-save] [-v] directory

Parse all XLSM files in a directory.

positional arguments:
  directory      Path to the directory containing XLSM files

options:
  -h, --help     show this help message and exit
  --no-save      Do not save data to database
  -v, --verbose  Display detailed parsing results
```

А ещё можете посмотреть пример использования ORM для анализа:

```bash
$ cd examples/
$ python four_buckets.py 

Анализ 25 игр:
Выгодно сохранить баллы: 17 игр (68.0%)
Невыгодно сохранять баллы: 5 игр (20.0%)
Без разницы: 3 игр (12.0%)
Средняя выгода: +1.84 мест

```

![](./doc/img/README/4_bucket_strategy_analysis_on_team.png)

Этот пример анализирует хранящиеся в БД игры не старше 365 дней с текущей даты. Проверяет, улучшила ли бы свои результаты команда "Суровая реальность", если бы не делала ставки в финальном раунде, а просто сохранила очки. При этом предполагается, что все остальные команды сыграли бы как было в реальности. Результат выдаётся в виде небольшого текстового отчёта в командной строке и визуализации, которая сохраняется в png-файл в каталоге из которого запущен скрипт.



#### Вспомогательные материалы

Чтобы анализировать накопленные данные по играм и клепать такие же красивенькие отчёты, как в примере выше, будет полезно ознакомиться со следующими документами:

- [Описание ORM](./doc/ORM.md)

- [Описание структуры данных](./doc/bd_game.md) для хранения полной информации об игре. Её возвращает функция `Database.get_game_data()`.

- [Код примера анализа](./examples/four_buckets.py)

  
